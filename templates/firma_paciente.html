{% extends "base.html" %}

{% block content %}
<div class="consentimiento-background">
    <div class="container py-4">
        <div class="page-logo text-center mb-2" style="margin-top: 10px;">
            <img src="{{ url_for('static', filename='img/LOGO-MENTALMENTE.png') }}" alt="MentalMente Logo" style="max-width: 180px; height: auto; margin-bottom: 0;">
        </div>
        <h2 class="text-center mb-3" style="margin-top: 0;">Consentimiento Informado - Firma del Paciente</h2>
        <div class="card mb-4" style="margin-top: 0;">
            <div class="card-header bg-primary text-white py-2">
                <h3 class="mb-0" style="font-size: 1.3rem;">Documento de Consentimiento</h3>
            </div>
            <div class="card-body consentimiento-texto px-4 py-3" style="max-height: 600px; overflow-y: auto;">
                <h4 class="text-center mb-3" style="font-size: 1.1rem;">AUTORIZAR PROCESO PSICOLÓGICO E INFORMACIÓN A TERCEROS</h4>
                <p class="mb-2">Yo <strong>{{ cita.paciente.nombre_completo }}</strong> identificado(a) con documento de identidad Nº 
                <strong>{{ cita.paciente.numero_identificacion }}</strong> de <strong>{{ cita.paciente.ciudad }}</strong>, en pleno uso de mis facultades legales y mentales, 
                de manera consciente y sin ninguna clase de presión, faculto y autorizo al profesional en psicología 
                <strong>{{ cita.psicologo.nombre_completo }}</strong>, para que realice proceso de evaluación, diagnóstico, 
                pronóstico, tratamiento, asesoría y orientación psicológica. Igualmente advierto que se me ha puesto en conocimiento, y acepto las terapias y procedimientos que el terapeuta considere son las
                adecuadas para mi condición psicológica o la del niño que represento.</p>
                <p class="mb-2">También se me ha ilustrado de manera clara y precisa, sobre: Rol del terapeuta, sus cualificaciones
                y alcances profesionales, los procedimientos terapéuticos y sus propósitos, las incomodidades o
                riesgos potenciales que se pueden derivar del proceso, los beneficios razonables que se pueden
                esperar acorde a mi participación, asistencia y compromiso con el proceso sean los indicados,
                alternativas posibles a la terapia dentro de la disciplina científica y los recursos del medio para
                brindarme apoyo, que puedo retirarme del proceso en cualquier momento, los límites de la confidencialidad y manejo de información de datos según disposiciones de ley.</p>
                <p class="mb-2">Además, se me informo así mismo, que al venir a proceso psicológico estoy aceptando un servicio para el cual debo suministrar la información necesaria para obtener beneficios del proceso, lo relacionado con el funcionamiento del proceso psicológico, las posibilidades de mejoramiento, la duración del tratamiento y la aplicación de técnicas y pruebas psicológicas pertinentes.</p>
                <ul class="mb-2">
                    <li>También se me explicó lo concerniente a la forma de pago y circunstancias relacionadas con el incumplimiento de las citas o deserción por parte mía o del terapeuta.</li>
                    <li>Que la confidencialidad de la profesión de psicología está regida por el artículo 2o, numeral 5o de la Ley 1090 de 2006: "Los psicólogos que ejerzan su profesión en Colombia se regirán por los siguientes principios universales: 5. Confidencialidad. Los psicólogos tienen una obligación básica respecto a la confidencialidad de la información obtenida de las personas en el desarrollo de su trabajo como psicólogos. Revelarán tal información a los demás solo con el consentimiento de la persona o del representante legal de la persona, excepto en aquellas circunstancias particulares en que no hacerlo llevaría a un evidente daño a la persona o a otros. Los psicólogos informarán a sus usuarios de las limitaciones legales de la confidencialidad".</li>
                </ul>
                <p class="mb-2">Autorizo con la firma de este documento que mi historia clínica sea suministrada a terceros en caso de que sea requerida para fines terapéuticos y/o jurídicos, según las disposiciones de ley.</p>
                <h5 class="text-center mt-4 mb-2" style="font-size: 1.05rem;">MANEJO DE DATOS PERSONALES</h5>
                <p class="mb-2">Declaro de manera libre, expresa, inequívoca e informada, que AUTORIZO a él profesional en psicología <strong>{{ cita.psicologo.nombre_completo }}</strong> para que, en los términos del literal a) del artículo 6 de la Ley 1581 de 2012, realice la recolección, almacenamiento, uso, circulación, supresión, y en general, tratamiento de mis datos personales, incluyendo datos sensibles, como la historia clínica y demás datos que puedan llegar a ser considerados como sensibles de conformidad con la Ley, para que dicho Tratamiento se realice con el fin de lograr las finalidades relativas a ejecutar el control, seguimiento, monitoreo, vigilancia y, en general, garantizar la seguridad de sus instalaciones; así como para documentar las actividades gremiales.</p>
                <p class="mb-2">Declaro que se me ha informado de manera clara y comprensible que tengo derecho a conocer, actualizar y rectificar los datos personales proporcionados, a solicitar prueba de esta autorización, a solicitar información sobre el uso que se le ha dado a mis datos personales, a presentar quejas ante la Superintendencia de Industria y comercio por el uso indebido de mis datos personales, a revocar esta autorización o solicitar la supresión de los datos personales suministrados y a acceder de forma gratuita a los mismos.</p>
                <p class="mb-2">Declaro que conozco y acepto el manual de tratamiento de datos personales de MentalMente Psicología Especializada y que la información por mí proporcionada es veraz, completa, exacta, actualizada y verificable. Mediante la firma del presente documento, manifiesto que reconozco y acepto que cualquier consulta o reclamación relacionada con el tratamiento de mis datos personales deberá ser presentada ante la Superintendencia de Industria y Comercio.</p>
                <p class="text-center mt-4 mb-1"><strong>Acepto las condiciones que se me presentan en este documento, dado en <strong>{{ cita.paciente.ciudad }}</strong>, el día {{ fecha_actual.strftime('%d') }} del mes {{ fecha_actual.strftime('%B') }} del año {{ fecha_actual.strftime('%Y') }}.</strong></p>
                <p class="text-center mb-0"><strong>Para constancia se firma la conformidad.</strong></p>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header bg-success text-white py-2">
                <h4 class="mb-0" style="font-size: 1.1rem;">Firma Digital</h4>
            </div>
            <div class="card-body py-3">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> Por favor dibuje su firma en el recuadro inferior para completar el consentimiento informado.
                </div>
                <form method="POST">
                    <div class="signature-container mb-3">
                        <canvas id="signature-pad" class="signature-pad"></canvas>
                    </div>
                    <input type="hidden" id="firma_paciente" name="firma_paciente">
                    <div class="d-flex justify-content-between">
                        <button type="button" id="clear" class="btn btn-secondary">
                            <i class="fas fa-eraser"></i> Limpiar Firma
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> Firmar y Enviar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="mt-5 mb-4">
            <table class="table table-bordered w-100" style="margin: 0 auto; max-width: 700px;">
                <tr>
                    <th class="text-center">Nombres y apellidos del paciente*</th>
                    <th class="text-center">Firma</th>
                    <th class="text-center">Fecha</th>
                </tr>
                <tr>
                    <td class="text-center">{{ cita.paciente.nombre_completo }}</td>
                    <td class="text-center">(Digital)</td>
                    <td class="text-center">{{ fecha_actual.strftime('%Y-%m-%d') }}</td>
                </tr>
                <tr>
                    <td class="text-center">C.C: {{ cita.paciente.numero_identificacion }}</td>
                    <td></td>
                    <td></td>
                </tr>
                {% if cita.paciente.tutor %}
                <tr><td colspan="3" style="height: 10px;"></td></tr>
                <tr>
                    <th class="text-center">Nombres y apellidos del Responsable del Paciente</th>
                    <th class="text-center">Ciudad</th>
                    <th class="text-center">Fecha</th>
                </tr>
                <tr>
                    <td class="text-center">{{ cita.paciente.tutor.nombre_completo }}</td>
                    <td class="text-center">{{ cita.paciente.tutor.ciudad }}</td>
                    <td class="text-center">{{ fecha_actual.strftime('%Y-%m-%d') }}</td>
                </tr>
                <tr>
                    <td class="text-center">C.C: {{ cita.paciente.tutor.numero_identificacion }}</td>
                    <td></td>
                    <td></td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)'
    });
    
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        signaturePad.clear();
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    document.getElementById('clear').addEventListener('click', function() {
        signaturePad.clear();
    });
    
    document.querySelector('form').addEventListener('submit', function(event) {
        if (signaturePad.isEmpty()) {
            alert("Por favor proporcione su firma antes de enviar.");
            event.preventDefault();
        } else {
            document.getElementById('firma_paciente').value = signaturePad.toDataURL('image/png');
        }
    });
});
</script>
{% endblock %}